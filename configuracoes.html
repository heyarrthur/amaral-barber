<!doctype html>
<html lang="pt-br" data-bs-theme="light">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Configurações — Amaral BarberShop</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        :root {
            --bs-primary: #0d6efd;
        }

        body {
            background: #f8fafc;
        }

        /* Navbar */
        .navbar {
            backdrop-filter: saturate(180%) blur(8px);
            background: rgba(255, 255, 255, .9) !important;
            box-shadow: 0 2px 12px rgba(0, 0, 0, .06);
        }

        .navbar-brand {
            font-weight: 700;
            letter-spacing: .3px;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: .5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: .5rem;
            font-weight: 500;
            color: #0f172a;
            padding: .5rem .9rem;
            border-radius: .75rem;
            transition: .2s;
        }

        .nav-link:hover {
            background: rgba(13, 110, 253, .08);
            color: var(--bs-primary);
        }

        .nav-link.active {
            color: #0d6efd;
            background: rgba(13, 110, 253, .12);
            box-shadow: inset 0 0 0 1px rgba(13, 110, 253, .25);
        }

        /* Layout */
        .content {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 800;
            color: #0f172a;
        }

        .card {
            border: 1px solid rgba(2, 6, 23, .06);
            border-radius: 1rem;
        }

        .help {
            color: #64748b;
        }

        /* Marcadores dos dias (não funciona) */
        .marker {
            border-radius: .75rem;
            padding: .5rem .85rem;
            border: 1px dashed rgba(2, 6, 23, .2);
            background: #fff;
            color: #0f172a;
            cursor: pointer;
            user-select: none;
        }

        .marker.active {
            background: #fee2e2;
            color: #b91c1c;
            border-color: #fecaca;
        }

        /* vermelho = NÃO funciona */

        /* Lista de folgas por membro */
        .member-row {
            background: #fff;
            border: 1px solid rgba(2, 6, 23, .08);
            border-radius: .85rem;
            padding: .6rem .75rem;
            display: flex;
            align-items: center;
            gap: .65rem;
        }

        .member-row .avatar {
            width: 36px;
            height: 36px;
            border-radius: 999px;
            display: grid;
            place-items: center;
            background: #eef4ff;
            color: #0d6efd;
        }

        /* Footer mini */
        .mini-note {
            font-size: .85rem;
            color: #64748b;
        }
    </style>
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg bg-body border-0 sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html"><i class="bi-scissors"></i> Amaral BarberShop</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMain">
                <ul class="navbar-nav ms-auto align-items-lg-center">
                    <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi-house-door"></i> Home</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="financeiro.html"><i class="bi-cash-stack"></i>
                            Financeiro</a></li>
                    <li class="nav-item"><a class="nav-link" href="equipe.html"><i class="bi-people"></i> Equipe</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="agendamentos.html"><i class="bi-calendar-event"></i>
                            Agendamentos</a></li>
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="#"><i class="bi-gear"></i>
                            Configurações</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="content">
        <div class="d-flex flex-wrap align-items-center mb-3 gap-2">
            <h5 class="mb-0 section-title"><i class="bi-gear me-1"></i> Configurações</h5>
            <div class="ms-auto d-flex flex-wrap gap-2">
                <button id="btnBackup" class="btn btn-primary">
                    <i class="bi-download me-1"></i> Exportar backup (.json)
                </button>

                <!-- Importar (input escondido) -->
                <label class="btn btn-outline-primary mb-0">
                    <i class="bi-upload me-1"></i> Importar backup
                    <input id="fileBackup" type="file" accept="application/json" hidden>
                </label>
            </div>
        </div>

        <div class="row g-3">
            <!-- Dados da Barbearia -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title mb-3"><i class="bi-shop me-1"></i> Dados da Barbearia</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input id="cNome" type="text" class="form-control" placeholder="Nome">
                                    <label for="cNome"><i class="bi-type"></i> Nome da Barbearia</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input id="cLocal" type="text" class="form-control" placeholder="Localização">
                                    <label for="cLocal"><i class="bi-geo-alt"></i> Localização da Barbearia</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input id="cCnpj" type="text" class="form-control" placeholder="CNPJ">
                                    <label for="cCnpj"><i class="bi-hash"></i> CNPJ</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input id="cTelefone" type="text" class="form-control" placeholder="Telefone">
                                    <label for="cTelefone"><i class="bi-telephone"></i> Telefone</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-floating">
                                    <input id="cEmail" type="email" class="form-control" placeholder="E-mail">
                                    <label for="cEmail"><i class="bi-envelope"></i> Email da Barbearia</label>
                                </div>
                            </div>
                        </div>
                        <div class="help mt-2 small">
                            Esses dados são usados nas outras páginas (Home, Financeiro, Equipe).
                        </div>
                    </div>
                </div>
            </div>

            <!-- Funcionamento -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title mb-3"><i class="bi-calendar-check me-1"></i> Dados de Funcionamento</h6>

                        <div class="mb-2 small help">
                            Quais dias da semana a barbearia <strong>não</strong> funciona? (os selecionados ficam <span
                                class="text-danger">vermelhos</span>)
                        </div>
                        <div id="diasMarkers" class="d-flex flex-wrap gap-2 mb-3"></div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cFolgasOn">
                            <label class="form-check-label" for="cFolgasOn">A equipe possui folgas?</label>
                        </div>

                        <div id="folgasBox" class="mt-3 d-none">
                            <div class="small help mb-2">Escolha o dia de folga de cada membro:</div>
                            <div id="folgasLista" class="row g-2"></div>
                            <div class="mini-note mt-2">Membros são carregados automaticamente do
                                <code>equipe.html</code>.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Observação -->
            <div class="col-12">
                <div class="alert alert-light border d-flex align-items-center" role="alert">
                    <i class="bi-info-circle me-2"></i>
                    As alterações são salvas automaticamente. Outras páginas (<strong>index.html</strong>,
                    <strong>financeiro.html</strong> e <strong>equipe.html</strong>) usam estes dados.
                </div>
            </div>
        </div>
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // =================== CONFIGURAÇÕES.JS (inline) ===================
        document.addEventListener('DOMContentLoaded', () => {
            /* ---------- Chaves e detecção ---------- */
            const CONFIG_CANDIDATES = [
                'abs_config_v3', 'abs_config_v2', 'abs_config_v1',
                'abs_configuracoes_v1', 'abs_configuracoes',
                'abs_config', 'amaral_config'
            ];
            function detectConfigKey() {
                for (const k of CONFIG_CANDIDATES) {
                    if (localStorage.getItem(k)) return k;
                }
                return 'abs_config_v3'; // padrão novo
            }
            let CONFIG_KEY = detectConfigKey();

            const EQ_KEYS = ['abs_equipe_v5', 'abs_equipe_v4', 'abs_equipe_v3', 'abs_equipe'];

            /* ---------- Helpers ---------- */
            const pad2 = (n) => String(n).padStart(2, '0');
            const dayNameToIdx = { 'domingo': 0, 'segunda': 1, 'terca': 2, 'terça': 2, 'quarta': 3, 'quinta': 4, 'sexta': 5, 'sabado': 6, 'sábado': 6 };

            function normalizeFechados(value) {
                if (!value) return [];
                if (!Array.isArray(value) && typeof value === 'object') {
                    value = Object.entries(value).filter(([, v]) => !!v).map(([k]) => k);
                }
                const arr = [];
                for (const x of value) {
                    if (typeof x === 'number') { arr.push(x); continue; }
                    if (typeof x === 'string') {
                        const key = x.trim().toLowerCase();
                        if (key in dayNameToIdx) arr.push(dayNameToIdx[key]);
                    }
                }
                return Array.from(new Set(arr)).sort((a, b) => a - b);
            }

            function normalizeConfig(inObj) {
                const base = {
                    barbearia: { nome: 'Amaral BarberShop', local: '', cnpj: '', telefone: '', email: '' },
                    funcionamento: { fechados: [], equipeFolgas: false, folgas: {} }
                };
                if (!inObj || typeof inObj !== 'object') return base;

                const b = inObj.barbearia || inObj.empresa || inObj.dados || {};
                base.barbearia.nome = b.nome || b.razao || inObj.nome || base.barbearia.nome;
                base.barbearia.local = b.local || b.endereco || inObj.local || '';
                base.barbearia.cnpj = b.cnpj || b.CNPJ || '';
                base.barbearia.telefone = b.telefone || b.phone || '';
                base.barbearia.email = b.email || b.mail || '';

                const f = inObj.funcionamento || inObj.horario || {};
                base.funcionamento.fechados = normalizeFechados(f.fechados || f.fechado || f.naoAbre || inObj.fechados || []);
                base.funcionamento.equipeFolgas = !!(f.equipeFolgas ?? f.folgasAtivas ?? inObj.equipeFolgas);
                base.funcionamento.folgas = f.folgas || inObj.folgas || {};

                return base;
            }

            function getEquipe() {
                for (const k of EQ_KEYS) {
                    const raw = localStorage.getItem(k);
                    if (raw) { try { return JSON.parse(raw) || null; } catch { } }
                }
                return null;
            }

            function saveConfig() { localStorage.setItem(CONFIG_KEY, JSON.stringify(config)); }

            /* ---------- Estado & DOM ---------- */
            let config = {
                barbearia: { nome: 'Amaral BarberShop', local: '', cnpj: '', telefone: '', email: '' },
                funcionamento: { fechados: [], equipeFolgas: false, folgas: {} }
            };

            const cNome = document.getElementById('cNome');
            const cLocal = document.getElementById('cLocal');
            const cCnpj = document.getElementById('cCnpj');
            const cTelefone = document.getElementById('cTelefone');
            const cEmail = document.getElementById('cEmail');

            const diasMarkers = document.getElementById('diasMarkers');
            const cFolgasOn = document.getElementById('cFolgasOn');
            const folgasBox = document.getElementById('folgasBox');
            const folgasLista = document.getElementById('folgasLista');

            const btnBackup = document.getElementById('btnBackup');
            const fileBackup = document.getElementById('fileBackup');

            /* ---------- Load inicial ---------- */
            (function loadConfig() {
                const raw = localStorage.getItem(CONFIG_KEY);
                if (raw) { try { config = normalizeConfig(JSON.parse(raw) || {}); } catch { } }
                // também migra se existir uma chave alternativa com dados mais novos
                for (const k of CONFIG_CANDIDATES) {
                    if (k !== CONFIG_KEY && localStorage.getItem(k)) {
                        const alt = localStorage.getItem(k);
                        if (alt && alt.length > (localStorage.getItem(CONFIG_KEY) || '').length) {
                            CONFIG_KEY = k;
                            try { config = normalizeConfig(JSON.parse(alt) || {}); } catch { }
                            break;
                        }
                    }
                }
            })();

            /* ---------- Preenche UI ---------- */
            function fillForm() {
                cNome.value = config.barbearia.nome || '';
                cLocal.value = config.barbearia.local || '';
                cCnpj.value = config.barbearia.cnpj || '';
                cTelefone.value = config.barbearia.telefone || '';
                cEmail.value = config.barbearia.email || '';
                cFolgasOn.checked = !!config.funcionamento.equipeFolgas;

                // Marcadores (Seg → Dom)
                const order = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
                const mapIdx = { 'Segunda': 1, 'Terça': 2, 'Quarta': 3, 'Quinta': 4, 'Sexta': 5, 'Sábado': 6, 'Domingo': 0 };
                const fech = config.funcionamento.fechados || [];
                diasMarkers.innerHTML = order.map(d => {
                    const idx = mapIdx[d];
                    const active = fech.includes(idx) ? 'active' : '';
                    return `<button type="button" class="marker ${active}" data-day="${idx}">${d}</button>`;
                }).join('');

                renderFolgas();
            }

            function renderFolgas() {
                folgasBox.classList.toggle('d-none', !cFolgasOn.checked);
                if (!cFolgasOn.checked) return;

                const eq = getEquipe();
                const members = (eq && Array.isArray(eq.membros)) ? eq.membros : [];
                const dayOpts = ['', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];

                if (!members.length) {
                    folgasLista.innerHTML = `
          <div class="col-12">
            <div class="alert alert-light border">
              <i class="bi-people me-1"></i> Nenhum membro encontrado. Cadastre em <a href="equipe.html" class="alert-link">equipe.html</a>.
            </div>
          </div>`;
                    return;
                }

                folgasLista.innerHTML = members.map(m => {
                    const cur = (config.funcionamento.folgas || {})[m.id] || '';
                    const iniciais = (m.nome || '?').split(' ').map(p => p[0]).slice(0, 2).join('').toUpperCase();
                    return `<div class="col-12 col-md-6">
          <div class="member-row">
            <div class="avatar"><strong>${iniciais}</strong></div>
            <div class="flex-grow-1">
              <div class="fw-semibold">${m.nome}</div>
              <div class="small help">${m.funcao || 'Membro'}</div>
            </div>
            <select class="form-select form-select-sm w-auto" data-mid="${m.id}">
              ${dayOpts.map(d => `<option value="${d}" ${d === cur ? 'selected' : ''}>${d || 'Sem folga'}</option>`).join('')}
            </select>
          </div>
        </div>`;
                }).join('');
            }

            fillForm();

            /* ---------- Listeners (salvamento automático) ---------- */
            [cNome, cLocal, cCnpj, cTelefone, cEmail].forEach(el => {
                el.addEventListener('input', () => {
                    config.barbearia = {
                        nome: cNome.value.trim(),
                        local: cLocal.value.trim(),
                        cnpj: cCnpj.value.trim(),
                        telefone: cTelefone.value.trim(),
                        email: cEmail.value.trim()
                    };
                    saveConfig();
                });
            });

            diasMarkers.addEventListener('click', (e) => {
                const btn = e.target.closest('.marker'); if (!btn) return;
                const d = Number(btn.dataset.day);
                const arr = config.funcionamento.fechados || (config.funcionamento.fechados = []);
                const ix = arr.indexOf(d);
                if (ix >= 0) arr.splice(ix, 1); else arr.push(d);
                btn.classList.toggle('active');
                saveConfig();
            });

            cFolgasOn.addEventListener('change', () => {
                config.funcionamento.equipeFolgas = cFolgasOn.checked;
                saveConfig();
                renderFolgas();
            });

            folgasLista.addEventListener('change', (e) => {
                const sel = e.target.closest('select[data-mid]'); if (!sel) return;
                const mid = sel.dataset.mid;
                (config.funcionamento.folgas ||= {})[mid] = sel.value; // string do dia ou ''
                saveConfig();
            });

            /* ---------- Backup: Exportar + Importar ---------- */
            // Exportar TUDO do localStorage (não só abs_). Útil para migrar o site inteiro.
            btnBackup.addEventListener('click', () => {
                const dump = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (k) dump[k] = localStorage.getItem(k);
                }
                const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                const dt = new Date();
                a.download = `backup_site_amaral_${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            });

            // Importar backup (mescla e sobrescreve chaves existentes; depois recarrega)
            fileBackup.addEventListener('change', async () => {
                const f = fileBackup.files[0]; if (!f) return;
                try {
                    const txt = await f.text();
                    const obj = JSON.parse(txt);

                    if (!obj || typeof obj !== 'object') {
                        alert('Arquivo inválido. Selecione um .json gerado pelo backup.');
                        return;
                    }

                    if (!confirm('Importar backup e substituir os dados existentes nas chaves presentes no arquivo?')) {
                        fileBackup.value = '';
                        return;
                    }

                    // Aplica todas as chaves do arquivo no localStorage
                    let count = 0;
                    for (const [k, v] of Object.entries(obj)) {
                        // Garante string no setItem
                        if (typeof v === 'string') localStorage.setItem(k, v);
                        else localStorage.setItem(k, JSON.stringify(v));
                        count++;
                    }

                    alert(`Backup importado (${count} chaves). A página será recarregada para aplicar as configurações.`);
                    location.reload();
                } catch (e) {
                    console.error(e);
                    alert('Não foi possível importar. Verifique o arquivo .json.');
                } finally {
                    fileBackup.value = ''; // permite reimportar o mesmo arquivo depois
                }
            });
        });
    </script>
</body>

</html>