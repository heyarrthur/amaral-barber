<!doctype html>
<html lang="pt-br" data-bs-theme="light">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Amaral BarberShop — Home</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --bs-primary: #0d6efd;
        }

        body {
            background: #f8fafc;
        }

        .navbar {
            backdrop-filter: saturate(180%) blur(8px);
            background: rgba(255, 255, 255, .9) !important;
            box-shadow: 0 2px 12px rgba(0, 0, 0, .06);
        }

        .navbar-brand {
            font-weight: 700;
            letter-spacing: .3px;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: .5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: .5rem;
            font-weight: 500;
            color: #0f172a;
            padding: .5rem .9rem;
            border-radius: .75rem;
            transition: .2s;
        }

        .nav-link:hover {
            background: rgba(13, 110, 253, .08);
            color: var(--bs-primary);
        }

        .nav-link.active {
            color: #0d6efd;
            background: rgba(13, 110, 253, .12);
            box-shadow: inset 0 0 0 1px rgba(13, 110, 253, .25);
        }

        .content {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .section-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: #0f172a;
        }

        .card {
            border: 1px solid rgba(2, 6, 23, .06);
            border-radius: 1rem;
        }

        .summary .label {
            color: #64748b;
            font-size: .85rem;
        }

        .summary .value {
            font-weight: 700;
            font-size: 1.15rem;
        }

        .value.pos {
            color: #16a34a;
        }

        .value.neg {
            color: #ef4444;
        }

        .table thead th {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 1;
        }

        .table-hover tbody tr:hover {
            background: #f6f9ff;
        }

        .filter-chip {
            border: 1px dashed rgba(13, 110, 253, .35);
            padding: .25rem .6rem;
            border-radius: 999px;
            font-size: .8rem;
            color: #0d6efd;
            background: #fff;
        }

        .empty-state {
            border: 2px dashed rgba(13, 110, 253, .3);
            border-radius: 1rem;
            padding: 1.25rem;
            text-align: center;
            color: #64748b;
            background: #fff;
        }

        .chart-fixed {
            position: relative;
            height: 260px;
        }

        .chart-fixed canvas {
            position: absolute;
            inset: 0;
            width: 100% !important;
            height: 100% !important;
        }

        .marker {
            border-radius: .75rem;
            padding: .5rem .8rem;
            border: 1px dashed rgba(2, 6, 23, .2);
            background: #fff;
            color: #0f172a;
            cursor: pointer;
        }

        .marker.active {
            background: #fee2e2;
            color: #b91c1c;
            border-color: #fecaca;
        }

        .toolbar .btn,
        .toolbar .input-group {
            height: 42px;
        }

        .toolbar .input-group .form-control {
            padding-top: .45rem;
            padding-bottom: .45rem;
        }
    </style>
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg bg-body border-0 sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi-scissors"></i> Amaral BarberShop</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navMain">
                <ul class="navbar-nav ms-auto align-items-lg-center">
                    <li class="nav-item"><a class="nav-link active" href="index.html"><i class="bi-house-door"></i> Home</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="financeiro.html"><i class="bi-cash-stack"></i>
                            Financeiro</a></li>
                    <li class="nav-item"><a class="nav-link" href="equipe.html"><i class="bi-people"></i> Equipe</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="agendamentos.html"><i class="bi-calendar-event"></i>
                            Agendamentos</a></li>
                    <li class="nav-item"><a class="nav-link" href="configuracoes.html"><i class="bi-gear"></i>
                            Configurações</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="content">
        <!-- ========= HOME ========= -->
        <section id="home" class="mb-4">
            <div class="d-flex flex-wrap align-items-center mb-3 toolbar">
                <h5 class="mb-0 section-title"><i class="bi-house me-1"></i> Home</h5>
                <div class="ms-auto d-flex flex-wrap toolbar">
                    <a href="financeiro.html" class="btn btn-primary"><i class="bi-plus-lg me-1"></i> Novo
                        lançamento</a>
                    <a href="equipe.html" class="btn btn-outline-primary"><i class="bi-person-plus me-1"></i>
                        Adicionar membro</a>
                </div>
            </div>

            <!-- Resumo -->
            <section class="summary mb-3">
                <div class="row g-3">
                    <div class="col-6 col-lg-3">
                        <div class="card p-3">
                            <div class="label"><i class="bi-calendar-day me-1"></i> Hoje</div>
                            <div class="value" id="hHoje">R$ 0,00</div>
                            <div class="small text-secondary" id="hHojeDesc">Receitas - Despesas</div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card p-3">
                            <div class="label"><i class="bi-calendar-week me-1"></i> Semana</div>
                            <div class="value" id="hSemana">R$ 0,00</div>
                            <div class="small text-secondary" id="hSemanaDesc">Receitas - Despesas</div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card p-3">
                            <div class="label"><i class="bi-calendar-month me-1"></i> Mês</div>
                            <div class="value" id="hMes">R$ 0,00</div>
                            <div class="small text-secondary" id="hMesDesc">Receitas - Despesas</div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card p-3">
                            <div class="label"><i class="bi-wallet2 me-1"></i> Saldo Total</div>
                            <div class="value" id="hTotal">R$ 0,00</div>
                            <div class="small text-secondary" id="hTotalDesc">Acumulado</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gráfico: Fluxo de caixa (6 meses) -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="card-title mb-3"><i class="bi-graph-up-arrow me-1"></i> Fluxo de caixa (6 meses)</h6>
                    <div class="chart-fixed"><canvas id="chartFluxo"></canvas></div>
                </div>
            </div>
        </section>

        <!-- ========= AGENDAMENTOS ========= -->
        <section id="agendamentos" class="mb-4">
            <div class="d-flex align-items-center mb-2">
                <h5 class="mb-0 section-title"><i class="bi-calendar-event me-1"></i> Agendamentos</h5>
                <button id="btnNovoAg" class="btn btn-primary ms-auto"><i class="bi-plus-lg me-1"></i> Novo
                    agendamento</button>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Hora</th>
                                    <th>Cliente</th>
                                    <th>Serviço</th>
                                    <th>Membro</th>
                                    <th class="text-end">Valor</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="agTbody"></tbody>
                        </table>
                        <div id="agEmpty" class="empty-state d-none">
                            <div class="mb-2"><i class="bi-emoji-smile"></i></div>
                            <div>Nenhum agendamento. Clique em <strong>Novo agendamento</strong> para começar.</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========= CONFIGURAÇÕES ========= -->
        <section id="configuracoes" class="mb-5">
            <h5 class="section-title mb-3"><i class="bi-gear me-1"></i> Configurações</h5>

            <div class="row g-3">
                <!-- Dados da Barbearia -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title mb-3"><i class="bi-shop me-1"></i> Dados da Barbearia</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input id="cNome" type="text" class="form-control"
                                            placeholder="Nome da Barbearia">
                                        <label for="cNome"><i class="bi-type"></i> Nome da Barbearia</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input id="cLocal" type="text" class="form-control" placeholder="Localização">
                                        <label for="cLocal"><i class="bi-geo-alt"></i> Localização da Barbearia</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input id="cCnpj" type="text" class="form-control" placeholder="CNPJ">
                                        <label for="cCnpj"><i class="bi-hash"></i> CNPJ</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input id="cTelefone" type="text" class="form-control" placeholder="Telefone">
                                        <label for="cTelefone"><i class="bi-telephone"></i> Telefone</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-floating">
                                        <input id="cEmail" type="email" class="form-control" placeholder="E-mail">
                                        <label for="cEmail"><i class="bi-envelope"></i> Email da Barbearia</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Funcionamento -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title mb-3"><i class="bi-calendar-check me-1"></i> Dados de Funcionamento
                            </h6>

                            <div class="mb-2 small text-secondary">Quais dias da semana a barbearia <strong>não</strong>
                                funciona?</div>
                            <div id="diasMarkers" class="d-flex flex-wrap gap-2 mb-3"></div>

                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="cFolgasOn">
                                <label class="form-check-label" for="cFolgasOn">A equipe possui folgas?</label>
                            </div>

                            <div id="folgasBox" class="mt-3 d-none">
                                <div class="small text-secondary mb-2">Selecione o dia de folga de cada membro:</div>
                                <div id="folgasLista" class="row g-2"></div>
                                <div class="small text-secondary mt-2">Obs.: membros são carregados de
                                    <code>equipe_v5.html</code>.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title mb-2"><i class="bi-cloud-arrow-down me-1"></i> Dados de Backup</h6>
                            <p class="mb-3 text-secondary">
                                Para realizar o backup, exporte o JSON e guarde-o. Ao formatar o computador ou trocar de
                                navegador, importe novamente para não perder os dados.
                            </p>
                            <div class="d-flex flex-wrap gap-2">
                                <button id="btnBackup" class="btn btn-primary"><i class="bi-download me-1"></i> Exportar
                                    backup</button>
                                <label class="btn btn-outline-primary mb-0">
                                    <i class="bi-upload me-1"></i> Importar backup
                                    <input id="fileBackup" type="file" accept="application/json" hidden>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- row -->
        </section>
    </main>

    <!-- MODAL: Novo agendamento -->
    <div class="modal fade" id="modalAg" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title"><i class="bi-calendar-plus me-1"></i> Novo agendamento</h6><button
                        class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formAg" class="row g-3">
                        <input type="hidden" id="agId">
                        <div class="col-md-6">
                            <div class="form-floating"><input id="agData" type="date" class="form-control"
                                    required><label for="agData"><i class="bi-calendar-event"></i> Data</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating"><input id="agHora" type="time" class="form-control"
                                    required><label for="agHora"><i class="bi-clock"></i> Hora</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating"><input id="agCliente" type="text" class="form-control"
                                    placeholder="Nome do cliente" required><label for="agCliente"><i
                                        class="bi-person"></i> Cliente</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating"><input id="agServico" type="text" class="form-control"
                                    placeholder="Serviço"><label for="agServico"><i class="bi-scissors"></i>
                                    Serviço</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating"><select id="agMembro" class="form-select">
                                    <option value="">Qualquer</option>
                                </select><label for="agMembro"><i class="bi-person-badge"></i> Membro</label></div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating"><input id="agValor" type="number" step="0.01" min="0"
                                    class="form-control" value="0"><label for="agValor"><i
                                        class="bi-currency-dollar"></i> Valor (R$)</label></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button id="btnSaveAg" class="btn btn-primary"><i class="bi-save me-1"></i> Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===== INDEX.JS — Amaral BarberShop (somente JS) =====
        document.addEventListener('DOMContentLoaded', () => {
            /* ===================== Chaves & Detecção ===================== */
            const CONFIG_CANDIDATES = [
                'abs_config_v3', 'abs_config_v2', 'abs_config_v1',
                'abs_configuracoes_v1', 'abs_configuracoes',
                'abs_config', 'amaral_config'
            ];
            function detectConfigKey() {
                for (const k of CONFIG_CANDIDATES) {
                    if (localStorage.getItem(k)) return k;
                }
                return 'abs_config_v1'; // fallback
            }
            let CONFIG_KEY = detectConfigKey();
            const AGENDA_KEY = 'abs_agenda_v1';
            const FIN_KEYS = ['abs_financeiro_v2fix', 'abs_financeiro_v2', 'abs_financeiro_v1'];
            const EQ_KEYS = ['abs_equipe_v5', 'abs_equipe_v4', 'abs_equipe_v3'];

            /* ===================== Helpers ===================== */
            const fmtBRL = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(Number(v || 0));
            const pad2 = n => String(n).padStart(2, '0');
            const todayStr = () => { const d = new Date(); return d.getFullYear() + '-' + pad2(d.getMonth() + 1) + '-' + pad2(d.getDate()); };
            const mondayOfWeek = (d) => { const x = new Date(d); const k = (x.getDay() + 6) % 7; x.setDate(x.getDate() - k); x.setHours(0, 0, 0, 0); return x; };
            const sundayOfWeek = (d) => { const m = mondayOfWeek(d); const s = new Date(m); s.setDate(m.getDate() + 6); s.setHours(23, 59, 59, 999); return s; };
            const fmtDMY = s => { if (!s) return ''; const [Y, M, D] = s.split('-'); return D + '/' + M + '/' + Y; };

            // Normalização de dias vindos da configurações.html
            const dayNameToIdx = { 'domingo': 0, 'segunda': 1, 'terca': 2, 'terça': 2, 'quarta': 3, 'quinta': 4, 'sexta': 5, 'sabado': 6, 'sábado': 6 };
            function normalizeFechados(value) {
                if (!value) return [];
                // Ex.: {segunda:true, domingo:true}
                if (!Array.isArray(value) && typeof value === 'object') {
                    value = Object.entries(value).filter(([, v]) => !!v).map(([k]) => k);
                }
                const arr = [];
                for (const x of value) {
                    if (typeof x === 'number') { arr.push(x); continue; }
                    if (typeof x === 'string') {
                        const key = x.trim().toLowerCase();
                        if (key in dayNameToIdx) arr.push(dayNameToIdx[key]);
                    }
                }
                return Array.from(new Set(arr)).sort((a, b) => a - b);
            }
            function normalizeConfig(inObj) {
                const base = {
                    barbearia: { nome: 'Amaral BarberShop', local: '', cnpj: '', telefone: '', email: '' },
                    funcionamento: { fechados: [], equipeFolgas: false, folgas: {} }
                };
                if (!inObj || typeof inObj !== 'object') return base;

                const b = inObj.barbearia || inObj.empresa || inObj.dados || {};
                base.barbearia.nome = b.nome || b.razao || inObj.nome || base.barbearia.nome;
                base.barbearia.local = b.local || b.endereco || inObj.local || '';
                base.barbearia.cnpj = b.cnpj || b.CNPJ || '';
                base.barbearia.telefone = b.telefone || b.phone || '';
                base.barbearia.email = b.email || b.mail || '';

                const f = inObj.funcionamento || inObj.horario || {};
                base.funcionamento.fechados = normalizeFechados(f.fechados || f.fechado || f.naoAbre || inObj.fechados || []);
                base.funcionamento.equipeFolgas = !!(f.equipeFolgas ?? f.folgasAtivas ?? inObj.equipeFolgas);
                base.funcionamento.folgas = f.folgas || inObj.folgas || {};

                return base;
            }

            /* ===================== Estado ===================== */
            let config = {
                barbearia: { nome: 'Amaral BarberShop', local: '', cnpj: '', telefone: '', email: '' },
                funcionamento: { fechados: [], equipeFolgas: false, folgas: {} }
            };
            let agenda = [];
            let chartFluxo = null;

            /* ===================== DOM ===================== */
            // Home resumo
            const hHoje = document.getElementById('hHoje');
            const hSemana = document.getElementById('hSemana');
            const hMes = document.getElementById('hMes');
            const hTotal = document.getElementById('hTotal');
            const hHojeDesc = document.getElementById('hHojeDesc');
            const hSemanaDesc = document.getElementById('hSemanaDesc');
            const hMesDesc = document.getElementById('hMesDesc');
            const hTotalDesc = document.getElementById('hTotalDesc');

            // Configurações
            const cNome = document.getElementById('cNome');
            const cLocal = document.getElementById('cLocal');
            const cCnpj = document.getElementById('cCnpj');
            const cTelefone = document.getElementById('cTelefone');
            const cEmail = document.getElementById('cEmail');

            const diasMarkers = document.getElementById('diasMarkers');
            const cFolgasOn = document.getElementById('cFolgasOn');
            const folgasBox = document.getElementById('folgasBox');
            const folgasLista = document.getElementById('folgasLista');

            // Backup
            const btnBackup = document.getElementById('btnBackup');
            const fileBackup = document.getElementById('fileBackup');

            // Agendamentos
            const agTbody = document.getElementById('agTbody');
            const agEmpty = document.getElementById('agEmpty');
            const btnNovoAg = document.getElementById('btnNovoAg');
            const modalAg = new bootstrap.Modal(document.getElementById('modalAg'));
            const btnSaveAg = document.getElementById('btnSaveAg');
            const agId = document.getElementById('agId');
            const agData = document.getElementById('agData');
            const agHora = document.getElementById('agHora');
            const agCliente = document.getElementById('agCliente');
            const agServico = document.getElementById('agServico');
            const agMembro = document.getElementById('agMembro');
            const agValor = document.getElementById('agValor');

            /* ===================== IO (LocalStorage) ===================== */
            function loadConfig() {
                const raw = localStorage.getItem(CONFIG_KEY);
                if (raw) {
                    try { config = normalizeConfig(JSON.parse(raw) || {}); } catch { }
                }
                // eslint-disable-next-line no-console
                console.log('[Config] usando chave:', CONFIG_KEY);
            }
            function saveConfig() { localStorage.setItem(CONFIG_KEY, JSON.stringify(config)); }

            function loadAgenda() {
                const raw = localStorage.getItem(AGENDA_KEY);
                if (raw) { try { agenda = JSON.parse(raw) || []; } catch { } }
            }
            function saveAgenda() { localStorage.setItem(AGENDA_KEY, JSON.stringify(agenda)); }

            function getLanc() {
                for (const k of FIN_KEYS) {
                    const raw = localStorage.getItem(k);
                    if (raw) { try { return JSON.parse(raw) || []; } catch { } }
                }
                return [];
            }
            function getEquipe() {
                for (const k of EQ_KEYS) {
                    const raw = localStorage.getItem(k);
                    if (raw) { try { return JSON.parse(raw) || null; } catch { } }
                }
                return null;
            }

            /* ===================== Home (Resumo + Gráfico) ===================== */
            function sumBy(arr, fn) { return arr.reduce((acc, it) => acc + (fn(it) || 0), 0); }

            function renderHome() {
                const lanc = getLanc();
                const now = new Date();

                function calc(start, end) {
                    const filtered = lanc.filter(it => {
                        const d = new Date((it.data || todayStr()) + 'T12:00:00');
                        return d >= start && d <= end;
                    });
                    const rec = sumBy(filtered, it => it.tipo === 'receita' ? Number(it.valor) : 0);
                    const des = sumBy(filtered, it => it.tipo === 'despesa' ? Number(it.valor) : 0);
                    return { rec, des, saldo: rec - des };
                }

                const rHoje = calc(new Date(now.getFullYear(), now.getMonth(), now.getDate()),
                    new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999));
                const rSem = calc(mondayOfWeek(now), sundayOfWeek(now));
                const rMes = calc(new Date(now.getFullYear(), now.getMonth(), 1),
                    new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999));
                const rTot = calc(new Date(2000, 0, 1), new Date(2100, 0, 1));

                const setVal = (node, v) => { node.textContent = fmtBRL(v); node.className = 'value ' + (v >= 0 ? 'pos' : 'neg'); };
                setVal(hHoje, rHoje.saldo); hHojeDesc.textContent = `${fmtBRL(rHoje.rec)} - ${fmtBRL(rHoje.des)}`;
                setVal(hSemana, rSem.saldo); hSemanaDesc.textContent = `${fmtBRL(rSem.rec)} - ${fmtBRL(rSem.des)}`;
                setVal(hMes, rMes.saldo); hMesDesc.textContent = `${fmtBRL(rMes.rec)} - ${fmtBRL(rMes.des)}`;
                setVal(hTotal, rTot.saldo); hTotalDesc.textContent = `${fmtBRL(rTot.rec)} - ${fmtBRL(rTot.des)}`;

                // Gráfico 6 meses
                const labels = [], rec = [], des = [];
                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const start = new Date(d.getFullYear(), d.getMonth(), 1);
                    const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23, 59, 59, 999);
                    labels.push(d.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' }));
                    rec.push(sumBy(lanc, it => { const di = new Date((it.data || todayStr()) + 'T12:00:00'); return (it.tipo === 'receita' && di >= start && di <= end) ? Number(it.valor) : 0; }));
                    des.push(sumBy(lanc, it => { const di = new Date((it.data || todayStr()) + 'T12:00:00'); return (it.tipo === 'despesa' && di >= start && di <= end) ? Number(it.valor) : 0; }));
                }
                if (chartFluxo) chartFluxo.destroy();
                const ctx = document.getElementById('chartFluxo');
                if (ctx) {
                    chartFluxo = new Chart(ctx, {
                        type: 'bar',
                        data: { labels, datasets: [{ label: 'Receitas', data: rec }, { label: 'Despesas', data: des }] },
                        options: {
                            responsive: true, maintainAspectRatio: false, resizeDelay: 200,
                            scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'bottom' } }, animation: { duration: 250 }
                        }
                    });
                }
            }

            /* ===================== Configurações (UI) ===================== */
            const diasPT_order = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
            const mapIdx = { 'Segunda': 1, 'Terça': 2, 'Quarta': 3, 'Quinta': 4, 'Sexta': 5, 'Sábado': 6, 'Domingo': 0 };

            function fillConfigForm() {
                if (cNome) cNome.value = config.barbearia.nome || '';
                if (cLocal) cLocal.value = config.barbearia.local || '';
                if (cCnpj) cCnpj.value = config.barbearia.cnpj || '';
                if (cTelefone) cTelefone.value = config.barbearia.telefone || '';
                if (cEmail) cEmail.value = config.barbearia.email || '';
                if (cFolgasOn) cFolgasOn.checked = !!config.funcionamento.equipeFolgas;

                if (diasMarkers) {
                    const fech = (config.funcionamento.fechados || []);
                    diasMarkers.innerHTML = diasPT_order.map(d => {
                        const idx = mapIdx[d];
                        const active = fech.includes(idx) ? 'active' : '';
                        return `<button type="button" class="marker ${active}" data-day="${idx}">${d}</button>`;
                    }).join('');
                }
                renderFolgasUI();
            }

            function renderFolgasUI() {
                if (!folgasBox) return;
                const on = !!(cFolgasOn && cFolgasOn.checked);
                folgasBox.classList.toggle('d-none', !on);
                if (!on) return;

                const eq = getEquipe();
                const members = eq && Array.isArray(eq.membros) ? eq.membros : [];
                const dayOpts = ['', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
                if (folgasLista) {
                    folgasLista.innerHTML = members.map(m => {
                        const cur = (config.funcionamento.folgas || {})[m.id] || '';
                        return `<div class="col-12 col-md-6">
          <div class="d-flex align-items-center gap-2 p-2 rounded border" style="background:#fff;">
            <i class="bi-person-circle fs-5 text-primary"></i>
            <div class="flex-grow-1">
              <div class="fw-semibold">${m.nome}</div>
              <div class="small text-secondary">${m.funcao || ''}</div>
            </div>
            <select class="form-select form-select-sm w-auto" data-mid="${m.id}">
              ${dayOpts.map(d => `<option value="${d}" ${d === cur ? 'selected' : ''}>${d || 'Sem folga'}</option>`).join('')}
            </select>
          </div>
        </div>`;
                    }).join('');
                }
            }

            // Listeners — salvam na mesma chave detectada
            [cNome, cLocal, cCnpj, cTelefone, cEmail].forEach(el => {
                if (!el) return;
                el.addEventListener('input', () => {
                    config.barbearia = {
                        nome: (cNome?.value || '').trim(),
                        local: (cLocal?.value || '').trim(),
                        cnpj: (cCnpj?.value || '').trim(),
                        telefone: (cTelefone?.value || '').trim(),
                        email: (cEmail?.value || '').trim()
                    };
                    saveConfig();
                });
            });

            if (diasMarkers) {
                diasMarkers.addEventListener('click', (e) => {
                    const btn = e.target.closest('.marker'); if (!btn) return;
                    const d = Number(btn.dataset.day);
                    const arr = config.funcionamento.fechados || (config.funcionamento.fechados = []);
                    const ix = arr.indexOf(d);
                    if (ix >= 0) arr.splice(ix, 1); else arr.push(d);
                    btn.classList.toggle('active');
                    saveConfig();
                });
            }

            if (cFolgasOn) {
                cFolgasOn.addEventListener('change', () => {
                    config.funcionamento.equipeFolgas = cFolgasOn.checked;
                    saveConfig();
                    renderFolgasUI();
                });
            }

            if (folgasLista) {
                folgasLista.addEventListener('change', (e) => {
                    const sel = e.target.closest('select[data-mid]'); if (!sel) return;
                    const mid = sel.dataset.mid;
                    const v = sel.value;
                    (config.funcionamento.folgas ||= {})[mid] = v; // string do dia ou ''
                    saveConfig();
                });
            }

            /* ===================== Backup ===================== */
            if (btnBackup) {
                btnBackup.addEventListener('click', () => {
                    const dump = {};
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith('abs_')) dump[k] = localStorage.getItem(k);
                    }
                    const blob = new Blob([JSON.stringify(dump, null, 2)], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    const dt = new Date();
                    a.download = `backup_amaral_${dt.getFullYear()}-${pad2(dt.getMonth() + 1)}-${pad2(dt.getDate())}.json`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                });
            }

            if (fileBackup) {
                fileBackup.addEventListener('change', async () => {
                    const f = fileBackup.files[0]; if (!f) return;
                    try {
                        const txt = await f.text();
                        const obj = JSON.parse(txt);
                        if (!confirm('Importar backup e substituir dados existentes?')) return;
                        Object.entries(obj).forEach(([k, v]) => {
                            if (k.startsWith('abs_')) localStorage.setItem(k, v);
                        });
                        alert('Backup importado! Recarregando…');
                        location.reload();
                    } catch (e) {
                        alert('Arquivo inválido.');
                    }
                });
            }

            /* ===================== Agendamentos ===================== */
            function loadMembersToSelect() {
                const eq = getEquipe();
                const members = eq && Array.isArray(eq.membros) ? eq.membros : [];
                if (agMembro) {
                    agMembro.innerHTML = '<option value="">Qualquer</option>' +
                        members.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
                }
            }

            function renderAgenda() {
                if (!agTbody || !agEmpty) return;
                if (!agenda.length) {
                    agTbody.innerHTML = '';
                    agEmpty.classList.remove('d-none');
                    return;
                }
                agEmpty.classList.add('d-none');
                const rows = [...agenda].sort((a, b) => (a.data + a.hora) > (b.data + b.hora) ? 1 : -1);
                agTbody.innerHTML = rows.map(a => `
      <tr data-id="${a.id}">
        <td>${fmtDMY(a.data)}</td>
        <td>${a.hora || ''}</td>
        <td>${a.cliente || ''}</td>
        <td>${a.servico || ''}</td>
        <td>${a.membroNome || ''}</td>
        <td class="text-end">${fmtBRL(a.valor || 0)}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" data-act="edit"><i class="bi-pencil"></i></button>
            <button class="btn btn-outline-danger" data-act="del"><i class="bi-trash"></i></button>
          </div>
        </td>
      </tr>
    `).join('');
            }

            if (btnNovoAg) {
                btnNovoAg.addEventListener('click', () => {
                    document.getElementById('formAg')?.reset();
                    if (agId) agId.value = '';
                    if (agData) agData.value = todayStr();
                    if (agHora) agHora.value = '09:00';
                    modalAg.show();
                });
            }

            if (btnSaveAg) {
                btnSaveAg.addEventListener('click', () => {
                    const obj = {
                        id: agId?.value || ('ag-' + Date.now() + Math.random().toString(16).slice(2)),
                        data: agData?.value, hora: agHora?.value, cliente: (agCliente?.value || '').trim(),
                        servico: (agServico?.value || '').trim(), membroId: agMembro?.value || '',
                        membroNome: agMembro?.value ? (agMembro.options[agMembro.selectedIndex].text) : '',
                        valor: Number(agValor?.value || 0)
                    };
                    const ix = agenda.findIndex(x => x.id === obj.id);
                    if (ix >= 0) agenda[ix] = obj; else agenda.push(obj);
                    saveAgenda(); modalAg.hide(); renderAgenda();
                });
            }

            if (agTbody) {
                agTbody.addEventListener('click', (e) => {
                    const tr = e.target.closest('tr[data-id]'); const btn = e.target.closest('button[data-act]');
                    if (!tr || !btn) return;
                    const id = tr.dataset.id; const it = agenda.find(x => x.id === id);
                    if (!it) return;
                    if (btn.dataset.act === 'edit') {
                        if (agId) agId.value = it.id;
                        if (agData) agData.value = it.data;
                        if (agHora) agHora.value = it.hora || '';
                        if (agCliente) agCliente.value = it.cliente || '';
                        if (agServico) agServico.value = it.servico || '';
                        if (agMembro) agMembro.value = it.membroId || '';
                        if (agValor) agValor.value = it.valor || 0;
                        modalAg.show();
                    } else if (btn.dataset.act === 'del') {
                        if (!confirm('Excluir agendamento?')) return;
                        agenda = agenda.filter(x => x.id !== id); saveAgenda(); renderAgenda();
                    }
                });
            }

            /* ===================== Init ===================== */
            loadConfig();             // puxa da configurações.html (qualquer chave conhecida)
            loadAgenda();
            loadMembersToSelect();
            fillConfigForm();
            renderAgenda();
            renderHome();

            // Atualiza resumo quando voltar de Financeiro
            window.addEventListener('focus', renderHome);
        });

    </script>
</body>

</html>